" leaders
let mapleader = ","

" filetype and intent
filetype plugin indent on

" incompatible plugins
if has('syntax') && has('eval')
  packadd! matchit
end

" hidden header
let g:netrw_banner=0

" gitgutter update faster
set updatetime=50

" highlight on
set hlsearch
set ignorecase
set smartcase
set incsearch

" highlight off
nmap <silent> <Esc><Esc> :<C-u>nohlsearch<CR><Esc>

" enable virtual editing in rectangle visual mode
set virtualedit=block

" fold
set foldmethod=indent
set foldlevel=99

" wildmenu
set wildmenu wildoptions=pum
set wildignorecase

" no swap, backup, undo
set noswapfile
set nobackup
set noundofile

" vim help japanese
set helplang=ja,en

" Vimã®ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
" ref: https://qiita.com/Linda_pp/items/9e0c94eb82b18071db34
if has('vim_starting')
    let &t_SI .= "\e[6 q" " æŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ç¸¦æ£’ã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
    let &t_EI .= "\e[2 q" " ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
    let &t_SR .= "\e[4 q" " ç½®æ›ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ä¸‹ç·šã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
endif

" ----------------------------------------------------------------------------
" PLUGINS
" ----------------------------------------------------------------------------

call plug#begin('~/.shared_cache/.vim/plugged')

Plug 'morhetz/gruvbox'                              " ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ
Plug 'vim-jp/vimdoc-ja'                             " Vimã®ãƒ˜ãƒ«ãƒ—ã‚’æ—¥æœ¬èªåŒ–
Plug 'itchyny/lightline.vim'                        " ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ã‚¤ãƒ³ãƒ»ã‚¿ãƒ–ãƒ©ã‚¤ãƒ³
  Plug 'shinchu/lightline-gruvbox.vim'
Plug 'tpope/vim-fugitive'
Plug 'airblade/vim-gitgutter'                       " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«git diffãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
Plug 'tyru/caw.vim'                                 " ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
Plug 'tpope/vim-rails'                              " Railsé–‹ç™ºã‚’ä¾¿åˆ©ã«ã™ã‚‹
Plug 'prabirshrestha/vim-lsp'
Plug 'mattn/vim-lsp-settings'                       " å„language-serverã‚’1ã‚³ãƒãƒ³ãƒ‰ã§å°å…¥ã§ãã‚‹
Plug 'prabirshrestha/asyncomplete.vim'              " éåŒæœŸã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
Plug 'prabirshrestha/asyncomplete-lsp.vim'          " asyncomplete.vimã®source
Plug 'rust-lang/rust.vim'
Plug 'github/copilot.vim'

call plug#end()

augroup vimrc_vim_plug_install
  autocmd!

  " è¶³ã‚Šãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Œã° :PlugInstall ã‚’å®Ÿè¡Œ
  autocmd VimEnter * if len(filter(values(g:plugs), '!isdirectory(v:val.dir)'))
    \| PlugInstall --sync | source $MYVIMRC
  \| endif
augroup END

" ----------------------------------------------------------------------------
" MAPPINGS
" ----------------------------------------------------------------------------
nmap PP "0p " ãƒ¤ãƒ³ã‚¯ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½¿ã£ã¦è²¼ã‚Šä»˜ã‘
map q <silent> " ã‚ˆããƒŸã‚¹ã‚¿ã‚¤ãƒ—ã™ã‚‹ã®ã§ãƒã‚¯ãƒ­è¨˜éŒ²ã—ãªã„ã‚ˆã†ã«ã™ã‚‹

" ãƒ¤ãƒ³ã‚¯ã—ãŸå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
augroup Yank
  au!
  autocmd TextYankPost * :call system('clip -i', @")
augroup END

imap <expr> <Tab>   pumvisible() ? "\<C-n>" : "\<Tab>"
imap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"
imap <expr> <cr>    pumvisible() ? asyncomplete#close_popup() : "\<cr>"

" ã‚«ãƒ¬ãƒ³ãƒˆãƒãƒƒãƒ•ã‚¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
command! CopyFilePath :echo "copied fullpath: " . expand('%:p') | let @"=expand('%:p') | call system('clip -i', @")

" ref: https://zenn.dev/kato_k/articles/vim-tips-no004
command! Profile call s:command_profile()
function! s:command_profile() abort
  profile start ~/profile.txt
  profile func *
  profile file *
endfunction

set background=dark " colorschemeãŒdarkã‚°ãƒ«ãƒ¼ãƒ—ã®é…è‰²ã‚’ä½¿ã†ã‚ˆã†ã«æŒ‡å®š
colorscheme gruvbox

augroup filepath_typescriptreact
  au!
  autocmd FileType typescriptreact :setl path+=**;/features/**
  autocmd FileType typescriptreact :setl includeexpr=substitute(v:fname,'^/','','')
augroup END

if !has('gui_running')
  set t_Co=256
endif

let g:lightline = {
  \ 'colorscheme': 'gruvbox',
  \ 'active': {
  \   'left': [ [ 'mode', 'paste' ],
  \             [ 'gitbranch', 'readonly', 'filename', 'modified' ],
  \           ]
  \ },
  \ 'component_function': {
  \   'gitbranch': 'fugitive#head',
  \ },
  \ }

let g:gitgutter_sign_added = '+'
let g:gitgutter_sign_modified = '>'
let g:gitgutter_sign_removed = '-'
let g:gitgutter_sign_removed_first_line = '^'
let g:gitgutter_sign_modified_removed = '<'

" ref: https://teratail.com/questions/29844#reply-46767
augroup vimrc_vim_gitgutter
  autocmd!
  " colorschemeèª­ã¿è¾¼ã¿å¾Œã€ã‚µã‚¤ãƒ³åˆ—ã®èƒŒæ™¯è‰²ã‚’NONEã«ã™ã‚‹ â€»Windows Terminalå´ã®è‰²ã‚’ä½¿ã„ãŸã„ãŸã‚
  autocmd VimEnter,ColorScheme * highlight SignColumn guibg=NONE ctermbg=NONE

  " colorschemeèª­ã¿è¾¼ã¿å¾Œã€ã‚µã‚¤ãƒ³åˆ—ã®è¨˜å·ã®è‰²ã‚’è¨­å®š
  autocmd VimEnter,ColorScheme * highlight GitGutterAdd guibg=NONE ctermbg=NONE guifg=#000900 ctermfg=2
  autocmd VimEnter,ColorScheme * highlight GitGutterChange guibg=NONE ctermbg=NONE guifg=#bbbb00 ctermfg=3
  autocmd VimEnter,ColorScheme * highlight GitGutterDelete guibg=NONE ctermbg=NONE guifg=#ff2222 ctermfg=1
augroup END

" hover scroll
nnoremap <buffer> <expr><c-f> lsp#scroll(+4)
nnoremap <buffer> <expr><c-b> lsp#scroll(-4)

let g:lsp_diagnostics_enabled = 1       " Diagnosticsã‚’æœ‰åŠ¹ã«ã™ã‚‹
let g:lsp_diagnostics_echo_cursor = 1   " ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã‚’ç”»é¢ä¸‹éƒ¨ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«è¡¨ç¤º
let g:lsp_diagnostics_echo_delay = 10
let g:lsp_diagnostics_float_cursor = 1  " ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã‚’ãƒ•ãƒ­ãƒ¼ãƒˆè¡¨ç¤º
let g:lsp_diagnostics_signs_enabled = 1 " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
let g:lsp_diagnostics_virtual_text_enabled = 0 " ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã®ä»®æƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
let g:lsp_diagnostics_signs_delay = 10
let g:lsp_diagnostics_signs_insert_mode_enabled = 0
let g:lsp_diagnostics_signs_error = {'text': 'ğŸ›'}
let g:lsp_diagnostics_signs_warning = {'text': 'ğŸª°'}
let g:lsp_diagnostics_signs_hint = {'text': 'ğŸ’¡'}
let g:lsp_diagnostics_signs_information = {'text': 'â„¹ï¸'}
let g:lsp_diagnostics_highlights_delay = 10
let g:lsp_diagnostics_highlights_insert_mode_enabled = 0
let g:lsp_document_code_action_signs_enabled = 0 " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«ã‚³ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤º

" vim-lsp ãŒãƒãƒƒãƒ•ã‚¡ã§æœ‰åŠ¹ã«ãªã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
" ãƒãƒƒãƒ•ã‚¡ãƒ­ãƒ¼ã‚«ãƒ«ãªã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®š
" See: https://mattn.kaoriya.net/software/vim/20191231213507.htm
function! s:on_lsp_buffer_enabled() abort
  let g:lsp_format_sync_timeout = 1000

  " golang
  " ãƒãƒƒãƒ•ã‚¡ä¿å­˜æ™‚ã«æ¯å›ã€Œimportè£œå®Œã€ã¨ã€Œã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã‚’å®Ÿè¡Œ
  autocmd BufWritePre *.go call execute(['LspCodeActionSync source.organizeImports', 'LspDocumentFormatSync'])
endfunction

augroup lsp_install
  au!
  autocmd User lsp_buffer_enabled call s:on_lsp_buffer_enabled()
augroup END

" debug
" let g:lsp_log_verbose = 1 " ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
" let g:lsp_log_file = expand('~/.shared_cache/.vim/vim-lsp.log') " ãƒ­ã‚°ã®å‡ºåŠ›å…ˆ

let g:lsp_settings_servers_dir='~/.shared_cache/.vim/servers'
let g:lsp_settings_filetype_ruby = ['solargraph']

let g:asyncomplete_popup_delay = 100

" ä¿å­˜æ™‚ã«è‡ªå‹•ã§rustfmt
let g:rustfmt_autosave = 1

let g:copilot_filetypes = { 'gitcommit': v:true }
