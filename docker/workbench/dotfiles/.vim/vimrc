" leaders
let mapleader = ","

" filetype and intent
filetype plugin indent on

" incompatible plugins
if has('syntax') && has('eval')
  packadd! matchit
end

" ----------------------------------------------------------------------------
" VIM SETTINGS
" ----------------------------------------------------------------------------

" set number                   " ç”»é¢å·¦ç«¯ã«è¡Œç•ªå·ã‚’è¡¨ç¤º
" set signcolumn=yes           " ç”»é¢å·¦ç«¯ã«ã‚µã‚¤ãƒ³åˆ—ã‚’å¸¸ã«è¡¨ç¤º
" set laststatus=2             " ç”»é¢æœ€ä¸‹éƒ¨ã«å¸¸ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
" set cmdheight=2              " ç”»é¢æœ€ä¸‹éƒ¨(ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œã‚ˆã‚Šä¸‹)ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ¬„ã‚’2è¡Œã«ã™ã‚‹
" set showtabline=2            " ã‚¿ãƒ–æ¯ã«å¸¸ã«ã‚¿ãƒ–ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º
" 
" set virtualedit=block        " çŸ©å½¢é¸æŠæ™‚ã«ä»®æƒ³ç·¨é›†ã‚’æœ‰åŠ¹åŒ–
" set wildmenu wildoptions=pum " ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§TABè£œå®Œæ™‚ã«å€™è£œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
" set wildignorecase           " ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§TABè£œå®Œæ™‚ã«å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
" 
" set tabstop=2                " ã‚¿ãƒ–ã‚’2æ–‡å­—åˆ†ã«ã™ã‚‹
" set expandtab                " ã‚¿ãƒ–ã®ä»£ã‚ã‚Šã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨
" set shiftwidth=2             " ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹2æ–‡å­—ã«ã™ã‚‹
" set smartindent              " æ–°ã—ã„è¡Œè¿½åŠ æ™‚ã«è‡ªå‹•ã§ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ 
" set foldmethod=indent        " åŒã˜ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’æŠ˜ã‚Šç•³ã‚€
" set foldlevel=100            " åˆæœŸè¡¨ç¤ºæ™‚ã«å‹æ‰‹ã«æŠ˜ã‚Šç•³ã¾ã‚Œãªã„ã‚ˆã†ã«æŠ˜ã‚Šç•³ã¿ãƒ¬ãƒ™ãƒ«ã‚’æ·±ã‚ã«è¨­å®š
" 
" set hlsearch                 " æ–‡å­—åˆ—æ¤œç´¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
" set ignorecase               " æ–‡å­—åˆ—æ¤œç´¢ã§å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
" set smartcase                " æ–‡å­—åˆ—æ¤œç´¢ã§å¤§æ–‡å­—ã‚’å«ã‚“ã§ã„ãŸã‚‰ignorecaseã‚’ä¸Šæ›¸ãã—ã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’åŒºåˆ¥ã™ã‚‹
" set incsearch                " ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒ
" 
" set noswapfile               " ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«(.swp)ã‚’ç”Ÿæˆã—ãªã„
" set nobackup                 " ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«(~)ã‚’ç”Ÿæˆã—ãªã„
" set noundofile               " undoãƒ•ã‚¡ã‚¤ãƒ«(.un~)ã‚’ç”Ÿæˆã—ãªã„
" set encoding=utf-8           " Vimå†…éƒ¨ã§ä½¿ã‚ã‚Œã‚‹æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«utf-8ã«ã™ã‚‹
" set updatetime=100           " æ›´æ–°æ™‚é–“ã‚’100msã«è¨­å®š
" set mouse=a                  " ãƒã‚¦ã‚¹æ“ä½œã‚’æœ‰åŠ¹ã«ã™ã‚‹
" set helplang=ja,en

" Vimã®ã‚«ãƒ¼ã‚½ãƒ«è¡¨ç¤º
" ref: https://qiita.com/Linda_pp/items/9e0c94eb82b18071db34
if has('vim_starting')
    let &t_SI .= "\e[6 q" " æŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ç¸¦æ£’ã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
    let &t_EI .= "\e[2 q" " ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
    let &t_SR .= "\e[4 q" " ç½®æ›ãƒ¢ãƒ¼ãƒ‰æ™‚ã«éç‚¹æ»…ã®ä¸‹ç·šã‚¿ã‚¤ãƒ—ã®ã‚«ãƒ¼ã‚½ãƒ«
endif

" ãƒãƒƒãƒ•ã‚¡ã«å…¥ã‚‹ã‹ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å–å¾—ã™ã‚‹ã¨ãã«ãƒªãƒ­ãƒ¼ãƒ‰
" augroup vimrc_vim_check_file_change
"   autocmd!
"   autocmd FocusGained,BufEnter * :checktime
" augroup END

" ----------------------------------------------------------------------------
" PLUGINS
" ----------------------------------------------------------------------------

call plug#begin('~/.shared_cache/.vim/plugged')

Plug 'morhetz/gruvbox'                              " ã‚«ãƒ©ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ
Plug 'vim-jp/vimdoc-ja'                             " Vimã®ãƒ˜ãƒ«ãƒ—ã‚’æ—¥æœ¬èªåŒ–
Plug 'liuchengxu/vim-which-key'
Plug 'itchyny/lightline.vim'                        " ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ã‚¤ãƒ³ãƒ»ã‚¿ãƒ–ãƒ©ã‚¤ãƒ³
  Plug 'shinchu/lightline-gruvbox.vim'
Plug 'tpope/vim-fugitive'
Plug 'airblade/vim-gitgutter'                       " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«git diffãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } } " Vimã§fzfã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
  Plug 'junegunn/fzf.vim'
  Plug 'yuki-yano/fzf-preview.vim', { 'branch': 'release/rpc' }
Plug 'lambdalisue/nerdfont.vim'                     " Windowså´ã«nerdfontã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹å¿…è¦ã‚ã‚Š
Plug 'tyru/caw.vim'                                 " ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
Plug 'junegunn/vim-easy-align'                      " ã„ã„æ„Ÿã˜ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’æƒãˆã‚‹
Plug 'andymass/vim-matchup'                         " å¯¾å¿œã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã®ãƒšã‚¢ã®è­˜åˆ¥ã‚’å¼·åŒ–
Plug 'tpope/vim-rails'                              " Railsé–‹ç™ºã‚’ä¾¿åˆ©ã«ã™ã‚‹
Plug 'mattn/vim-maketable'                          " ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«è¡¨è¨˜ã«å¤‰æ›
Plug 'prabirshrestha/vim-lsp'
Plug 'mattn/vim-lsp-settings'                       " å„language-serverã‚’1ã‚³ãƒãƒ³ãƒ‰ã§å°å…¥ã§ãã‚‹
Plug 'prabirshrestha/asyncomplete.vim'              " éåŒæœŸã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
Plug 'prabirshrestha/asyncomplete-lsp.vim'          " asyncomplete.vimã®source
Plug 'voldikss/vim-floaterm'                        " ãƒ•ãƒ­ãƒ¼ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã
Plug 'thinca/vim-qfreplace'                         " quickfixã®ç½®æ›
Plug 'rust-lang/rust.vim'
Plug 'thinca/vim-quickrun'                          " ã‚·ãƒ¥ãƒƒã¨ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
Plug 'github/copilot.vim'

call plug#end()

augroup vimrc_vim_plug_install
  autocmd!

  " è¶³ã‚Šãªã„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚Œã° :PlugInstall ã‚’å®Ÿè¡Œ
  autocmd VimEnter * if len(filter(values(g:plugs), '!isdirectory(v:val.dir)'))
    \| PlugInstall --sync | source $MYVIMRC
  \| endif
augroup END

" ----------------------------------------------------------------------------
" MAPPINGS
" ----------------------------------------------------------------------------
nmap <silent> <Esc><Esc> :<C-u>nohlsearch<CR><Esc> " æ–‡å­—åˆ—æ¤œç´¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚ªãƒ•
nmap PP "0p " ãƒ¤ãƒ³ã‚¯ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ä½¿ã£ã¦è²¼ã‚Šä»˜ã‘
map q <silent> " ã‚ˆããƒŸã‚¹ã‚¿ã‚¤ãƒ—ã™ã‚‹ã®ã§ãƒã‚¯ãƒ­è¨˜éŒ²ã—ãªã„ã‚ˆã†ã«ã™ã‚‹

" ãƒ¤ãƒ³ã‚¯ã—ãŸå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
augroup Yank
  au!
  autocmd TextYankPost * :call system('clip -i', @")
augroup END

imap <expr> <Tab>   pumvisible() ? "\<C-n>" : "\<Tab>"
imap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"
imap <expr> <cr>    pumvisible() ? asyncomplete#close_popup() : "\<cr>"

" ----------------------------------------------------------------------------
" VIM SETTINGS & PLUGIN SETTINGS
" ----------------------------------------------------------------------------

" .vim/config/*.vim ã‚’é †æ¬¡èª­ã¿è¾¼ã‚€
"   prefix:
"     000 - Vimè¨­å®š
"     100 - Vimè¨­å®šã«å½±éŸ¿ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®š
"     200 - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—é–¢é€£
"     300 - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å›ºæœ‰è¨­å®š

call map(
  \ sort(split(globpath(&runtimepath, 'config/*.vim'))),
  \ {-> execute('exec "source" v:val') }
  \ )

" ã‚«ãƒ¬ãƒ³ãƒˆãƒãƒƒãƒ•ã‚¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
command! CopyFilePath :echo "copied fullpath: " . expand('%:p') | let @"=expand('%:p') | call system('clip -i', @")

" fzfã§ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®gitç®¡ç†ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
command! -bang -nargs=? GFilesCwd
  \ call fzf#vim#gitfiles(<q-args>, fzf#vim#with_preview(<q-args> == '?' ? { 'dir': getcwd(), 'placeholder': '' } : { 'dir': getcwd() }), <bang>0)

" globã‚’æŒ‡å®šã—ã¦ã€Rgã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
" graphqlã‚’å«ã‚€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«çµã‚Šè¾¼ã‚“ã§æ¤œç´¢ :Rgglob '**/*graphql*/**'
" graphqlã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã«çµã‚Šè¾¼ã‚“ã§æ¤œç´¢ :Rgglob '*graphql*'
function! Rgglob(query, fullscreen)
  let glob_pattern = input("glob pattern? : ", "'**/*ptn*/**'")
  call fzf#vim#grep("rg --column --hidden --line-number --no-heading --color=always --ignore-case "."-g ".glob_pattern." -- ".shellescape(a:query), 1, fzf#vim#with_preview(), a:fullscreen)
endfunction

command! -nargs=* Rgglob call Rgglob("", 0)

" ref: https://zenn.dev/kato_k/articles/vim-tips-no004
command! Profile call s:command_profile()
function! s:command_profile() abort
  profile start ~/profile.txt
  profile func *
  profile file *
endfunction

set background=dark " colorschemeãŒdarkã‚°ãƒ«ãƒ¼ãƒ—ã®é…è‰²ã‚’ä½¿ã†ã‚ˆã†ã«æŒ‡å®š
colorscheme gruvbox

augroup filepath_typescriptreact
  au!
  autocmd FileType typescriptreact :setl path+=**;/features/**
  autocmd FileType typescriptreact :setl includeexpr=substitute(v:fname,'^/','','')
augroup END

set timeoutlen=500 " 100msã ã¨ä»–ã®ã‚­ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ãŒä¸Šæ‰‹ãå‹•ã‹ãªã„ãŸã‚500msã«è¨­å®š

let g:which_key_ignore_outside_mappings = 1 " è¾æ›¸ã«ãªã„ãƒãƒƒãƒ”ãƒ³ã‚°ã¯éè¡¨ç¤ºã«ã™ã‚‹
let g:which_key_sep = 'â†’'
let g:which_key_use_floating_win = 0

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key s
" windows
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map_window = { 'name' : '+windows' }
call which_key#register('s', 'g:which_key_map_window')
nmap s :<c-u>WhichKey 's'<CR>
vmap s :<c-u>WhichKeyVisual 's'<CR>

let g:which_key_map_window.s    = [':sp'              , 'split horizontaly']
let g:which_key_map_window.v    = [':vs'              , 'split verticaly']
let g:which_key_map_window.h    = ['<C-w>h'           , 'focus left']
let g:which_key_map_window.j    = ['<C-w>j'           , 'focus down']
let g:which_key_map_window.k    = ['<C-w>k'           , 'focus up']
let g:which_key_map_window.l    = ['<C-w>l'           , 'focus right']
let g:which_key_map_window.H    = ['<C-w>H'           , 'move left']
let g:which_key_map_window.J    = ['<C-w>J'           , 'move down']
let g:which_key_map_window.K    = ['<C-w>K'           , 'move up']
let g:which_key_map_window.L    = ['<C-w>L'           , 'move right']
let g:which_key_map_window['<'] = [':vert resize -10 ', 'resize left']
let g:which_key_map_window['>'] = [':vert resize +10' , 'resize right']
let g:which_key_map_window['-'] = [':resize -10'      , 'resize down']
let g:which_key_map_window['+'] = [':resize +10'      , 'resize up']

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key t
" tabs
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map_tabs = { 'name' : '+tabs' }
call which_key#register('t', 'g:which_key_map_tabs')
nmap t :<c-u>WhichKey 't'<CR>
vmap t :<c-u>WhichKeyVisual 't'<CR>

let g:which_key_map_tabs.e = [':tabedit'   , 'new']
let g:which_key_map_tabs.t = [':tab split' , 'split']
let g:which_key_map_tabs.h = [':tabprev'   , 'focus left']
let g:which_key_map_tabs.l = [':tabnext'   , 'focus right']
let g:which_key_map_tabs.H = [':tabmove -1', 'move left']
let g:which_key_map_tabs.L = [':tabmove +1', 'move right']

" ----------------------------------------------------------------------------------------------------------------------
" Leader key map bindings
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map = {}
call which_key#register('<Space>', 'g:which_key_map')
nmap <leader> :<c-u>WhichKey '<leader>'<CR>
vmap <leader> :<c-u>WhichKeyVisual '<leader>'<CR>

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>b
" buffers
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.b = {
  \ 'name' : '+buffers'    ,
  \ 'b'    : [':Buffers'   , 'buffers'],
  \ 'n'    : [':bnext'     , 'next'],
  \ 'p'    : [':bprevious' , 'previous'],
  \ 'd'    : [':bd'        , 'destroy'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>f
" files
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.f = {
  \ 'name' : '+files'                                         ,
  \ 'b'    : [':Git blame'                                    , 'blame'],
  \ 'g'    : [':Rgglob'                                       , 'grep glob pattern'],
  \ 'l'    : [':BCommits'                                     , 'current logs'],
  \ 'f'    : [':Rg'                                           , 'grep'],
  \ 'h'    : [':History'                                      , 'history'],
  \ 'p'    : [':GFilesCwd'                                    , 'project files'],
  \ 's'    : [':GFiles?'                                      , 'git status files'],
  \ '/'    : [':BLines'                                       , 'line'],
  \}

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>F
" fold
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.F = {
  \ 'name' : '+fold'              ,
  \ 'O'    : [':set foldlevel=20' , 'open all'],
  \ 'C'    : [':set foldlevel=0'  , 'close all'],
  \ 'c'    : [':foldclose'        , 'close'],
  \ 'o'    : [':foldopen'         , 'open'],
  \ '1'    : [':set foldlevel=1'  , 'level1'],
  \ '2'    : [':set foldlevel=2'  , 'level2'],
  \ '3'    : [':set foldlevel=3'  , 'level3'],
  \ '4'    : [':set foldlevel=4'  , 'level4'],
  \ '5'    : [':set foldlevel=5'  , 'level5'],
  \ '6'    : [':set foldlevel=6'  , 'level6']
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>M
" markdown
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.M = {
  \ 'name' : '+markdown'     ,
  \ 'm'    : [':MakeTable'   , 'make table'],
  \ 'M'    : [':MakeTable!'  , 'make table!'],
  \ 'u'    : [':UnmakeTable' , 'unmake table'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>l
" lsp
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.l = {
  \ 'name' : '+lsp'                            ,
  \ 'a'    : [':LspCodeAction'                 , 'code action'],
  \ 'd'    : [':LspDocumentDiagnostics'        , 'diagnostics'],
  \ 'f'    : [':LspDocumentFormat'             , 'format'],
  \ 'h'    : [':LspHover'                      , 'hover'],
  \ 'l'    : [':LspCodeLens'                   , 'code Lens'],
  \ 'r'    : [':LspRename'                     , 'rename symbol'],
  \ '/'    : [':FzfPreviewVimLspReferencesRpc' , 'fzf references'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>lg
" goto
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.l.g = {
  \ 'name' : '+goto'               ,
  \ 'd'    : [':LspDefinition'     , 'goto definition'],
  \ 'y'    : [':LspTypeDefinition' , 'goto type definition'],
  \ 'i'    : [':LspImplementation' , 'goto implementation'],
  \ 'r'    : [':LspReferences'     , 'goto references'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>p
" package
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.p = {
  \ 'name' : '+package'       ,
  \ 'c'    : [':PlugClean'    , 'clean'],
  \ 'd'    : [':PlugDiff'     , 'diff'],
  \ 'i'    : [':PlugInstall'  , 'install'],
  \ 's'    : [':PlugSnapshot' , 'snapshot'],
  \ 'S'    : [':PlugStatus'   , 'status'],
  \ 'u'    : [':PlugUpgrade'  , 'upgrade'],
  \ 'U'    : [':PlugUpdate'   , 'update'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <Leader>q
" quickfix
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_map.q = {
  \ 'name' : '+quickfix'               ,
  \ 'n'    : [':cn'                    , 'next line'],
  \ 'p'    : [':cnf'                   , 'previous line'],
  \ 'N'    : [':cp'                    , 'next file'],
  \ 'P'    : [':cpf'                   , 'previous file'],
  \ 'o'    : [':cwindow'               , 'open'],
  \ 'c'    : [':cclose'                , 'close'],
  \ 'q'    : [':FzfPreviewQuickFixRpc' , 'search'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" LocalLeader key map bindings
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_local_map = {}
call which_key#register(',', 'g:which_key_local_map')
nmap <localleader> :<c-u>WhichKey '<localleader>'<CR>
vmap <localleader> :<c-u>WhichKeyVisual '<localleader>'<CR>

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <localleader>t
" terminal
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_local_map.t = {
  \ 'name' : '+terminal'             ,
  \ 't'    : [':FloatermNew'         , 'terminal'],
  \ 'z'    : [':FloatermNew lazygit' , 'lazygit'],
  \ }

" ----------------------------------------------------------------------------------------------------------------------
" Prefix Key <localleader>,
" util
" ----------------------------------------------------------------------------------------------------------------------
let g:which_key_local_map[','] = {
  \ 'name' : '+util'                         ,
  \ 'c'    : [':CopyFilePath'                , 'copy filepath'],
  \ 'j'    : [':FzfPreviewJumpsRpc'          , 'jump history'],
  \ 'm'    : [':Maps'                        , 'mappings'],
  \ 's'    : [':Git'                         , 'git status'],
  \ 'r'    : [':FzfPreviewCommandPaletteRpc' , 'command history'],
  \ '/'    : [':History/'                    , 'search history'],
  \ }

if !has('gui_running')
  set t_Co=256
endif

let g:lightline = {
  \ 'colorscheme': 'gruvbox',
  \ 'active': {
  \   'left': [ [ 'mode', 'paste' ],
  \             [ 'gitbranch', 'readonly', 'filename', 'modified' ],
  \           ]
  \ },
  \ 'component_function': {
  \   'gitbranch': 'fugitive#head',
  \ },
  \ }

let g:gitgutter_sign_added = '+'
let g:gitgutter_sign_modified = '>'
let g:gitgutter_sign_removed = '-'
let g:gitgutter_sign_removed_first_line = '^'
let g:gitgutter_sign_modified_removed = '<'

" ref: https://teratail.com/questions/29844#reply-46767
augroup vimrc_vim_gitgutter
  autocmd!
  " colorschemeèª­ã¿è¾¼ã¿å¾Œã€ã‚µã‚¤ãƒ³åˆ—ã®èƒŒæ™¯è‰²ã‚’NONEã«ã™ã‚‹ â€»Windows Terminalå´ã®è‰²ã‚’ä½¿ã„ãŸã„ãŸã‚
  autocmd VimEnter,ColorScheme * highlight SignColumn guibg=NONE ctermbg=NONE

  " colorschemeèª­ã¿è¾¼ã¿å¾Œã€ã‚µã‚¤ãƒ³åˆ—ã®è¨˜å·ã®è‰²ã‚’è¨­å®š
  autocmd VimEnter,ColorScheme * highlight GitGutterAdd guibg=NONE ctermbg=NONE guifg=#000900 ctermfg=2
  autocmd VimEnter,ColorScheme * highlight GitGutterChange guibg=NONE ctermbg=NONE guifg=#bbbb00 ctermfg=3
  autocmd VimEnter,ColorScheme * highlight GitGutterDelete guibg=NONE ctermbg=NONE guifg=#ff2222 ctermfg=1
augroup END

" hover scroll
nnoremap <buffer> <expr><c-f> lsp#scroll(+4)
nnoremap <buffer> <expr><c-b> lsp#scroll(-4)

let g:lsp_diagnostics_enabled = 1       " Diagnosticsã‚’æœ‰åŠ¹ã«ã™ã‚‹
let g:lsp_diagnostics_echo_cursor = 1   " ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã‚’ç”»é¢ä¸‹éƒ¨ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã«è¡¨ç¤º
let g:lsp_diagnostics_echo_delay = 10
let g:lsp_diagnostics_float_cursor = 1  " ã‚«ãƒ¼ã‚½ãƒ«ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã‚’ãƒ•ãƒ­ãƒ¼ãƒˆè¡¨ç¤º
let g:lsp_diagnostics_signs_enabled = 1 " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
let g:lsp_diagnostics_virtual_text_enabled = 0 " ã‚¨ãƒ©ãƒ¼ã€è­¦å‘Šã€æƒ…å ±ã€ãƒ’ãƒ³ãƒˆã®ä»®æƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
let g:lsp_diagnostics_signs_delay = 10
let g:lsp_diagnostics_signs_insert_mode_enabled = 0
let g:lsp_diagnostics_signs_error = {'text': 'ğŸ›'}
let g:lsp_diagnostics_signs_warning = {'text': 'ğŸª°'}
let g:lsp_diagnostics_signs_hint = {'text': 'ğŸ’¡'}
let g:lsp_diagnostics_signs_information = {'text': 'â„¹ï¸'}
let g:lsp_diagnostics_highlights_delay = 10
let g:lsp_diagnostics_highlights_insert_mode_enabled = 0
let g:lsp_document_code_action_signs_enabled = 0 " ç”»é¢å·¦ç«¯ã®ã‚µã‚¤ãƒ³åˆ—ã«ã‚³ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤º

" vim-lsp ãŒãƒãƒƒãƒ•ã‚¡ã§æœ‰åŠ¹ã«ãªã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
" ãƒãƒƒãƒ•ã‚¡ãƒ­ãƒ¼ã‚«ãƒ«ãªã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®š
" See: https://mattn.kaoriya.net/software/vim/20191231213507.htm
function! s:on_lsp_buffer_enabled() abort
  let g:lsp_format_sync_timeout = 1000

  " golang
  " ãƒãƒƒãƒ•ã‚¡ä¿å­˜æ™‚ã«æ¯å›ã€Œimportè£œå®Œã€ã¨ã€Œã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã‚’å®Ÿè¡Œ
  autocmd BufWritePre *.go call execute(['LspCodeActionSync source.organizeImports', 'LspDocumentFormatSync'])
endfunction

augroup lsp_install
  au!
  autocmd User lsp_buffer_enabled call s:on_lsp_buffer_enabled()
augroup END

" debug
" let g:lsp_log_verbose = 1 " ãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
" let g:lsp_log_file = expand('~/.shared_cache/.vim/vim-lsp.log') " ãƒ­ã‚°ã®å‡ºåŠ›å…ˆ

let g:lsp_settings_servers_dir='~/.shared_cache/.vim/servers'
let g:lsp_settings_filetype_ruby = ['solargraph']

let g:asyncomplete_popup_delay = 100

let g:fzf_layout = { 'window': { 'width': 0.9, 'height': 0.9 } }

function! s:build_quickfix_list(lines)
  call setqflist(map(copy(a:lines), '{ "filename": v:val }'))
  copen
  cc
endfunction
let g:fzf_action = {
  \ 'ctrl-q': function('s:build_quickfix_list'),
  \ 'ctrl-e': 'tab split',
  \ 'ctrl-s': 'split',
  \ 'ctrl-v': 'vsplit' }

let g:floaterm_shell = 'bash'
let g:floaterm_height = 0.9
let g:floaterm_width = 0.9
let g:floaterm_autoclose = 2

let g:floaterm_keymap_new    = '<F7>'
let g:floaterm_keymap_prev   = '<F8>'
let g:floaterm_keymap_next   = '<F9>'
let g:floaterm_keymap_toggle = '<F12>'

" ä¿å­˜æ™‚ã«è‡ªå‹•ã§rustfmt
let g:rustfmt_autosave = 1

let g:quickrun_config = {}
let g:quickrun_config.rust = {'exec' : 'cargo run'}

let g:copilot_filetypes = { 'gitcommit': v:true }
